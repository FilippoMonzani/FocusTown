// --------------------------------------------------------
// Code generated by Papyrus Java
// --------------------------------------------------------

package main;

import java.awt.EventQueue;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.FocusEvent;
import java.awt.event.FocusListener;
import java.time.Duration;

import javax.swing.JButton;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JTextField;
import javax.swing.Timer;

import org.apache.logging.log4j.Level;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import com.formdev.flatlaf.FlatLightLaf;

import model.AuthenticationService;
import model.City;
import model.DataGroupByStrategy;
import model.GroupByNumberOfBuildings;
import model.GroupByStudyHours;
import model.User;
import view.AppView;
import view.LoginView;
import view.RegView;
import view.SessionSettingView;
import view.StatsView;
import view.SubjectSessionView;
import view.TimerCountdownView;
import view.View;

/************************************************************/
/**
 * 
 */
public class FocusApp {

	private static LoginView loginView = null;
	private static RegView regView = null;
	private static AppView appView = null;
	private static StatsView statsView = null;
	private static SessionSettingView sessionSettingView = null;
	private static TimerCountdownView timerCountdownView = null;
	private static SubjectSessionView subjectSessionView = null;

	private static User currentUser = null;
	private static City currentCity = null;
	private static Timer timer;


	private static final Logger logger = LogManager.getLogger(FocusApp.class);
	private boolean sessionInterrupted;

	private static HistogramManager histogramManager;

	public static void main(String[] args) {
		FlatLightLaf.setup();
		EventQueue.invokeLater(new Runnable() {
			public void run() {
				try {
					loginView = new LoginView();
					regView = new RegView();
					appView = new AppView();
					statsView = new StatsView();
					sessionSettingView = new SessionSettingView();
					timerCountdownView = new TimerCountdownView();
					subjectSessionView = new SubjectSessionView();

					loginView.setVisible(true);

					currentCity = new City();
					histogramManager = new HistogramManager(statsView.getHistogram());

					setDestinations();
					setFunctionalities();
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		});
	}

	/**
	 * Define the destination of every button here
	 */
	private static void setDestinations() {
		setBtnDestination(loginView.getBtnReg(), loginView, regView);
		setBtnDestination(regView.getBackToLoginBtn(), regView, loginView);
		setBtnDestination(statsView.getBackBtn(), statsView, appView);
		setBtnDestination(appView.getStatsButton(), appView, statsView);
		setBtnDestination(appView.getStartBtn(), appView, sessionSettingView);
		setBtnDestination(appView.getUserBtn(), appView, loginView);
		setBtnDestination(sessionSettingView.getCancelButton(), sessionSettingView, appView);
	}

	/**
	 * Define the action listener of every button here
	 */
	private static void setFunctionalities() {
		regView.getBtnReg().addActionListener(a -> {
			try {
				addUser();
				regView.showSuccessMessage();
				loginView.setVisible(true);
				regView.setVisible(false);
			} catch (DuplicateUserException e) {
				regView.showErrorMessage("Questo nome utente è già preso.");
			}
		});

		loginView.getLoginBtn().addActionListener(a -> {
			String usernameLogin = loginView.getUsername();
			String passwordLogin = loginView.getPassword();

			AuthenticationService authService = new AuthenticationService();
			User u = new User(usernameLogin, passwordLogin);

			try {
				FocusApp.currentUser = authService.login(u, passwordLogin);
				logger.info("Utente <" + currentUser.getUsername() + "> ha effettuato il login.");
				initBuilding();
				// after succesful authentication, appView is shown
				appView.setVisible(true);
				loginView.setVisible(false);
			} catch (UserNotFoundException e) {
				loginView.showErrorMessage("Questo nome utente non esiste.");
			} catch (WrongPasswordException e) {
				loginView.showErrorMessage("Password errata.");
			}
		});
		
		sessionSettingView.getHourField().addFocusListener(new FocusListener() {

			@Override
			public void focusLost(FocusEvent e) {

				if (!sessionSettingView.getHourField().getText().matches("\\d+")) {
					sessionSettingView.getErrorLabel().setText("Error: hour values must be integers.");
					sessionSettingView.getHourField().setText("");
				} else {
					sessionSettingView.getErrorLabel().setText("");
				}
				int hours = Integer.parseInt(sessionSettingView.getHourField().getText());
				int minutes = Integer.parseInt(sessionSettingView.getMinuteField().getText());
				int newHours = TimeManager.calculateHours(hours, minutes);
				if (newHours == 24) {
					minutes = 0;
				}
				sessionSettingView.getHourField().setText(((Integer) newHours).toString());
				sessionSettingView.getMinuteField().setText(((Integer) minutes).toString());
			}

			@Override
			public void focusGained(FocusEvent e) {
				// TODO document why this method is empty
			}
		});

		sessionSettingView.getMinuteField().addFocusListener(new FocusListener() {

			@Override
			public void focusLost(FocusEvent e) {

				if (!sessionSettingView.getMinuteField().getText().matches("\\d+")) {
					sessionSettingView.getErrorLabel().setText("Error: minute values must be integers.");
					sessionSettingView.getMinuteField().setText("");
				} else {
					sessionSettingView.getErrorLabel().setText("");
				}
				int hours = Integer.parseInt(sessionSettingView.getHourField().getText());
				int minutes = Integer.parseInt(sessionSettingView.getMinuteField().getText());
				int newHours = TimeManager.calculateHours(hours, minutes);
				minutes = minutes % 60;
				if (newHours == 24) {
					minutes = 0;
				}
				sessionSettingView.getHourField().setText(((Integer) newHours).toString());
				sessionSettingView.getMinuteField().setText(((Integer) minutes).toString());
			}

			@Override
			public void focusGained(FocusEvent e) {
				// TODO document why this method is empty
			}
		});
		
		
		sessionSettingView.getStartButton().addActionListener(a -> {
			boolean correctInput = false;
	            	if(!sessionSettingView.getHourField().getText().matches("\\d+") || !sessionSettingView.getMinuteField().getText().matches("\\d+")) {
	            		sessionSettingView.getErrorLabel().setText("Error: hour and minute values must be integers.");
	            	}
	            	else {
	            		sessionSettingView.getErrorLabel().setText("");
	            	}
	            	
	            	if(sessionSettingView.getMinuteField().getText().matches("\\d+") && Integer.parseInt(sessionSettingView.getMinuteField().getText()) > 59) {
	        			sessionSettingView.getErrorLabel().setText("Error: minutes value must be smaller than 60.");
	            	}
	            	int hours = Integer.parseInt(sessionSettingView.getHourField().getText());
	            	int minutes = Integer.parseInt(sessionSettingView.getMinuteField().getText());
	            	int seconds = 60*60*hours + 60*minutes;
	    			timerCountdownView.setVisible(true);
	            		sessionSettingView.setVisible(false);
		    			startTimer(seconds);
	            	
		});
		
		timerCountdownView.getStopButton().addActionListener(a -> {
			int confirm = JOptionPane.showConfirmDialog(null, "Are you sure you want to stop the timer?", "Confirm Stop", JOptionPane.YES_NO_OPTION, JOptionPane.QUESTION_MESSAGE);
            if (confirm == JOptionPane.YES_OPTION) {
                timer.stop();
                sessionSettingView.setVisible(true);
                timerCountdownView.setVisible(false);
            }
		});
            

		statsView.getDataSelect().addActionListener(a -> {
			DataGroupByStrategy strategy = switch (statsView.getSelectedData()) {
			case 0 -> new GroupByNumberOfBuildings();
			case 1 -> new GroupByStudyHours();
			default -> new GroupByNumberOfBuildings();
			};
			histogramManager.setStrategy(strategy);
			updateStatsHistogram();
		});

		statsView.getMonthSelect().addActionListener(a -> updateStatsHistogram());

		statsView.getYearSelect().addActionListener(a -> updateStatsHistogram());

		
	}

	/***
	 * Set the destination view for a button
	 * 
	 * @param btn    Button that brings to view "dest" when clicked
	 * @param source View that contains the button
	 * @param dest   Destination view
	 */
	private static void setBtnDestination(JButton btn, View source, View dest) {
		btn.addActionListener(a -> {
			source.setVisible(false);
			dest.setVisible(true);
		});
	}

	/**
	 * 
	 * @param duration
	 * @return
	 * @return
	 */
	public static void startTimer(int duration) {
		boolean sessionInterrupted = false;
		String subject = null;
		timer = new Timer(1000,new ActionListener() {
			 int count = duration;
			 TimeManager time = new TimeManager(count);

			@Override
			public void actionPerformed(ActionEvent e) { 
				count--;
				time.tick();
				
				timerCountdownView.getTimerLabel().setText("Time remaining " + time.toString());
				if(sessionInterrupted) {
					timer.stop();
				}
				else if(time.isZero()) {
					timer.stop();
					subjectSessionView.setVisible(true);
					timerCountdownView.setVisible(false);
				}
			}
		});
		
		timer.setInitialDelay(0);
		timer.start();
	}

	/**
	 * 
	 */
	public static void endTimer(String subject, int seconds) {
		Duration duration =  Duration.ofSeconds(seconds);
		currentCity.addBuilding(duration, subject, currentUser);
	}

	private static void addUser() {
		User user = new User(regView.getUsername(), regView.getPassword());
		if (user.read() != null) {
			throw new DuplicateUserException();
		} else {
			user.save();
		}
	}

	public static Logger getLogger() {
		return FocusApp.logger;
	}

	private static void updateStatsHistogram() {
		int year = statsView.getSelectedYear();
		int month = statsView.getSelectedMonth();
		logger.log(Level.DEBUG, String.format("Looking at buildings from %d, %d", year, month));
		histogramManager.updateHistogram(year, month);
	}

	/**
	 * 
	 * call loadBuilding method for the current city
	 * 
	 * @param user
	 * 
	 */
	private static void initBuilding() {
		currentCity.loadBuildings(currentUser);
	}
}
